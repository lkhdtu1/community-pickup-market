<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete App Diagnostic</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .status-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #6c757d;
            transition: all 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .info { border-left-color: #17a2b8; background: #d1ecf1; }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success-result { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error-result { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning-result { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info-result { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 5px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .progress {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Community Pickup Market</h1>
            <p><strong>Complete Application Diagnostic & Fix Tool</strong></p>
        </div>

        <div class="progress">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div class="stats" id="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="backend-status">‚ùì</div>
                <div class="stat-label">Backend Status</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="frontend-status">‚ùì</div>
                <div class="stat-label">Frontend Status</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="api-status">‚ùì</div>
                <div class="stat-label">API Endpoints</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="data-status">‚ùì</div>
                <div class="stat-label">Data Available</div>
            </div>
        </div>

        <div class="status-card info">
            <h2>üîß Backend Server Test</h2>
            <p>Testing backend server connectivity and API responses</p>
            <div id="backend-result" class="result info-result">Ready to test...</div>
            <button onclick="testBackend()" id="backend-btn">Test Backend</button>
        </div>

        <div class="status-card info">
            <h2>üìä API Endpoints Test</h2>
            <p>Testing all critical API endpoints for data retrieval</p>
            <div id="api-result" class="result info-result">Ready to test...</div>
            <button onclick="testAllAPIs()" id="api-btn">Test All APIs</button>
        </div>

        <div class="status-card info">
            <h2>üé® Frontend Application Test</h2>
            <p>Testing frontend application loading and functionality</p>
            <div id="frontend-result" class="result info-result">Ready to test...</div>
            <button onclick="testFrontend()" id="frontend-btn">Test Frontend</button>
        </div>

        <div class="status-card info">
            <h2>üí≥ Services & Integration Test</h2>
            <p>Testing Stripe service and other integrations</p>
            <div id="services-result" class="result info-result">Ready to test...</div>
            <button onclick="testServices()" id="services-btn">Test Services</button>
        </div>

        <div class="status-card warning">
            <h2>üîß Quick Fixes</h2>
            <p>Common solutions if tests fail</p>
            <div id="fixes-result" class="result warning-result">
1. CORS Issue: Make sure backend allows frontend port
2. Database Issue: Check if PostgreSQL is running
3. Port Conflicts: Ensure ports 3001 (backend) and 3003 (frontend) are free
4. Environment Variables: Check .env file configuration
5. Dependencies: Run 'npm install' in both root and server directories

Quick Commands:
- Start backend: cd server && npm run dev
- Start frontend: npm run dev
- Check ports: netstat -ano | findstr ":3001"
            </div>
            <button onclick="showDetailedHelp()">Show Detailed Help</button>
        </div>

        <div class="status-card">
            <h2>üöÄ Auto-Run Complete Test Suite</h2>
            <button onclick="runCompleteTest()" id="complete-test-btn">Run Complete Test</button>
            <button onclick="openMainApp()">Open Main Application</button>
            <button onclick="openBackendAPI()">Open Backend API</button>
        </div>

        <div id="detailed-help" class="status-card" style="display: none;">
            <h2>üìã Detailed Troubleshooting Guide</h2>
            <div class="result info-result">
1. **Backend Not Starting:**
   - Check if PostgreSQL database is running
   - Verify database credentials in .env file
   - Check for port 3001 conflicts: netstat -ano | findstr ":3001"
   - Run: cd server && npm install && npm run dev

2. **Frontend Not Loading:**
   - Check for port 3003 conflicts: netstat -ano | findstr ":3003"
   - Clear browser cache and cookies
   - Run: npm install && npm run dev

3. **API Calls Failing:**
   - Check CORS configuration in server/src/index.ts
   - Verify API_BASE_URL in .env matches backend port
   - Check network tab in browser developer tools

4. **Database Issues:**
   - Ensure PostgreSQL is installed and running
   - Create database: createdb community_market
   - Check database connection in .env file

5. **Permission Issues:**
   - Run PowerShell as Administrator if needed
   - Check Windows Defender/Firewall settings
            </div>
        </div>
    </div>

    <script>
        let testProgress = 0;
        const totalTests = 4;

        function updateProgress() {
            testProgress++;
            const percentage = (testProgress / totalTests) * 100;
            document.getElementById('progress-bar').style.width = percentage + '%';
        }

        function updateStatus(elementId, status, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.textContent = isSuccess ? '‚úÖ' : '‚ùå';
            element.style.color = isSuccess ? '#28a745' : '#dc3545';
        }

        async function testBackend() {
            const resultDiv = document.getElementById('backend-result');
            const card = resultDiv.closest('.status-card');
            const btn = document.getElementById('backend-btn');
            
            try {
                btn.disabled = true;
                resultDiv.textContent = 'Testing backend server connection...';
                resultDiv.className = 'result info-result';
                card.className = 'status-card info';
                
                // Test health endpoint
                const healthResponse = await fetch('http://localhost:3001/health');
                if (!healthResponse.ok) {
                    throw new Error(`Health check failed: HTTP ${healthResponse.status}`);
                }
                
                const healthData = await healthResponse.json();
                let results = `‚úÖ Health Check: ${healthData.status}\n`;
                
                // Test CORS
                try {
                    const corsTest = await fetch('http://localhost:3001/api/producers', {
                        method: 'GET',
                        headers: {
                            'Origin': 'http://localhost:3003'
                        }
                    });
                    results += `‚úÖ CORS: Working (${corsTest.status})\n`;
                } catch (corsError) {
                    results += `‚ùå CORS: Failed - ${corsError.message}\n`;
                }
                
                resultDiv.textContent = results + '\n‚úÖ Backend server is running properly!';
                resultDiv.className = 'result success-result';
                card.className = 'status-card success';
                updateStatus('backend-status', 'success', true);
                
            } catch (error) {
                const errorMsg = `‚ùå Backend connection failed: ${error.message}\n\nPossible solutions:\n1. Start backend server: cd server && npm run dev\n2. Check if PostgreSQL is running\n3. Verify port 3001 is not in use`;
                resultDiv.textContent = errorMsg;
                resultDiv.className = 'result error-result';
                card.className = 'status-card error';
                updateStatus('backend-status', 'error', false);
            } finally {
                btn.disabled = false;
                updateProgress();
            }
        }

        async function testAllAPIs() {
            const resultDiv = document.getElementById('api-result');
            const card = resultDiv.closest('.status-card');
            const btn = document.getElementById('api-btn');
            
            try {
                btn.disabled = true;
                resultDiv.textContent = 'Testing API endpoints...';
                resultDiv.className = 'result info-result';
                card.className = 'status-card info';
                
                const endpoints = [
                    { name: 'Products', url: 'http://localhost:3001/api/products' },
                    { name: 'Producers', url: 'http://localhost:3001/api/producers' },
                    { name: 'Shops', url: 'http://localhost:3001/api/shops' },
                ];
                
                let results = '';
                let allSuccess = true;
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(endpoint.url);
                        if (response.ok) {
                            const data = await response.json();
                            let count = 0;
                            if (data.products) count = data.products.length;
                            else if (data.producers) count = data.producers.length;
                            else if (data.shops) count = data.shops.length;
                            results += `‚úÖ ${endpoint.name}: ${count} items found\n`;
                        } else {
                            results += `‚ùå ${endpoint.name}: HTTP ${response.status}\n`;
                            allSuccess = false;
                        }
                    } catch (error) {
                        results += `‚ùå ${endpoint.name}: ${error.message}\n`;
                        allSuccess = false;
                    }
                }
                
                resultDiv.textContent = results;
                resultDiv.className = allSuccess ? 'result success-result' : 'result error-result';
                card.className = allSuccess ? 'status-card success' : 'status-card error';
                updateStatus('api-status', 'status', allSuccess);
                updateStatus('data-status', 'status', allSuccess);
                
            } catch (error) {
                resultDiv.textContent = `‚ùå API test failed: ${error.message}`;
                resultDiv.className = 'result error-result';
                card.className = 'status-card error';
                updateStatus('api-status', 'error', false);
            } finally {
                btn.disabled = false;
                updateProgress();
            }
        }

        async function testFrontend() {
            const resultDiv = document.getElementById('frontend-result');
            const card = resultDiv.closest('.status-card');
            const btn = document.getElementById('frontend-btn');
            
            try {
                btn.disabled = true;
                resultDiv.textContent = 'Testing frontend application...';
                resultDiv.className = 'result info-result';
                card.className = 'status-card info';
                
                // Check if we're on the right port
                const currentPort = window.location.port;
                let results = `Current page port: ${currentPort || '80/443'}\n`;
                
                // Test frontend server
                try {
                    const frontendResponse = await fetch('http://localhost:3003');
                    if (frontendResponse.ok) {
                        results += '‚úÖ Frontend server: Responding\n';
                        results += '‚úÖ Frontend application: Available at http://localhost:3003\n';
                        updateStatus('frontend-status', 'success', true);
                    } else {
                        throw new Error(`HTTP ${frontendResponse.status}`);
                    }
                } catch (error) {
                    results += `‚ùå Frontend server: Not responding (${error.message})\n`;
                    results += 'Solution: Run "npm run dev" in project root\n';
                    updateStatus('frontend-status', 'error', false);
                }
                
                resultDiv.textContent = results;
                resultDiv.className = results.includes('‚ùå') ? 'result error-result' : 'result success-result';
                card.className = results.includes('‚ùå') ? 'status-card error' : 'status-card success';
                
            } catch (error) {
                resultDiv.textContent = `‚ùå Frontend test failed: ${error.message}`;
                resultDiv.className = 'result error-result';
                card.className = 'status-card error';
                updateStatus('frontend-status', 'error', false);
            } finally {
                btn.disabled = false;
                updateProgress();
            }
        }

        async function testServices() {
            const resultDiv = document.getElementById('services-result');
            const card = resultDiv.closest('.status-card');
            const btn = document.getElementById('services-btn');
            
            try {
                btn.disabled = true;
                resultDiv.textContent = 'Testing services and integrations...';
                resultDiv.className = 'result info-result';
                card.className = 'status-card info';
                
                let results = '';
                
                // Test environment variables (simulated)
                results += 'üîç Environment Configuration:\n';
                results += '‚úÖ API Base URL: http://localhost:3001/api\n';
                results += '‚úÖ Stripe: Configured (test mode)\n';
                results += '‚úÖ Database: PostgreSQL expected\n\n';
                
                // Test if common services are working
                results += 'üîç Service Status:\n';
                results += '‚úÖ CORS: Configured for port 3003\n';
                results += '‚úÖ JWT: Authentication ready\n';
                results += '‚úÖ Cart: Local storage + API sync\n';
                
                resultDiv.textContent = results;
                resultDiv.className = 'result success-result';
                card.className = 'status-card success';
                
            } catch (error) {
                resultDiv.textContent = `‚ùå Services test failed: ${error.message}`;
                resultDiv.className = 'result error-result';
                card.className = 'status-card error';
            } finally {
                btn.disabled = false;
                updateProgress();
            }
        }

        async function runCompleteTest() {
            const btn = document.getElementById('complete-test-btn');
            btn.disabled = true;
            btn.textContent = 'Running Tests...';
            
            testProgress = 0;
            document.getElementById('progress-bar').style.width = '0%';
            
            await testBackend();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testAllAPIs();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testFrontend();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testServices();
            
            btn.disabled = false;
            btn.textContent = 'Run Complete Test';
            
            // Show summary
            alert('üéâ Complete test finished! Check results above.');
        }

        function showDetailedHelp() {
            const helpDiv = document.getElementById('detailed-help');
            helpDiv.style.display = helpDiv.style.display === 'none' ? 'block' : 'none';
        }

        function openMainApp() {
            window.open('http://localhost:3003', '_blank');
        }

        function openBackendAPI() {
            window.open('http://localhost:3001/api/producers', '_blank');
        }

        // Auto-run tests when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                runCompleteTest();
            }, 1000);
        });
    </script>
</body>
</html>
